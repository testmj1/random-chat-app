<!DOCTYPE html>
<html>
<head>
  <title>Random Chat</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #videos { display: flex; gap: 10px; margin-top: 10px; }
    video { width: 300px; height: 220px; background: black; }
    #chatBox { border: 1px solid #ccc; height: 200px; overflow-y: auto; margin-top: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h2>Random Chat</h2>
  <button id="startText">Start Text Chat</button>
  <button id="startVideo">Start Video Chat</button>
  <button id="nextBtn" disabled>Next</button>

  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div id="chatBox"></div>
  <input id="msgInput" placeholder="Type message..." />
  <button id="sendBtn">Send</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const startText = document.getElementById("startText");
    const startVideo = document.getElementById("startVideo");
    const nextBtn = document.getElementById("nextBtn");
    const chatBox = document.getElementById("chatBox");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    let partnerId = null;
    let room = null;
    let mode = null;
    let pc = null;

    // --- JOIN ---
    startText.onclick = () => {
      socket.emit("join", "text");
      mode = "text";
      clearChat();
      logStatus("Searching for text partner...");
    };

    startVideo.onclick = () => {
      socket.emit("join", "video");
      mode = "video";
      clearChat();
      logStatus("Searching for video partner...");
    };

    // --- NEXT ---
    nextBtn.onclick = () => {
      cleanup();
      clearChat();
      socket.emit("next");
      logStatus("Searching again...");
      nextBtn.disabled = true;
    };

    // --- SEND CHAT ---
    sendBtn.onclick = () => {
      if (!room) return;
      const msg = msgInput.value;
      if (!msg) return;
      socket.emit("chat", { room, message: msg });
      addMessage("You: " + msg);
      msgInput.value = "";
    };

    // --- SOCKET EVENTS ---
    socket.on("waiting", () => {
      logStatus("Waiting for partner...");
    });

    socket.on("paired", async ({ partnerId: pid, mode: m, room: r }) => {
      partnerId = pid;
      mode = m;
      room = r;
      logStatus("Paired! Say hello!");
      nextBtn.disabled = false;

      if (mode === "video") {
        setupPeer();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("signal", { to: partnerId, data: { type: "offer", sdp: offer } });
      }
    });

    socket.on("chat", ({ from, message }) => {
      if (from === socket.id) return;
      addMessage("Stranger: " + message);
    });

    socket.on("signal", async ({ from, data }) => {
      if (!pc) setupPeer();
      if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("signal", { to: from, data: { type: "answer", sdp: answer } });
      } else if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      } else if (data.type === "candidate") {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (err) {
          console.error("Error adding candidate", err);
        }
      }
    });

    socket.on("partner-left", () => {
      logStatus("Partner left. Press Next to continue.");
      cleanup();
      clearChat();
    });

    // --- FUNCTIONS ---
    function setupPeer() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("signal", { to: partnerId, data: { type: "candidate", candidate: event.candidate } });
        }
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
        localVideo.srcObject = stream;
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));
      });
    }

    function addMessage(msg) {
      chatBox.innerHTML += msg + "<br/>";
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function logStatus(msg) {
      chatBox.innerHTML += "<i>" + msg + "</i><br/>";
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearChat() {
      chatBox.innerHTML = "";
    }

    function cleanup() {
      if (pc) {
        pc.close();
        pc = null;
      }
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;
    }
  </script>
</body>
</html>
